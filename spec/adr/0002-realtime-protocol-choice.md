# ADR 0002: リアルタイム通信方式 (SSE vs WebSocket)

- Status: Proposed
- Date: 2024-05-20
- Owner: Fire Pocker チーム

## 背景
- Fire Pocker では、投票・開示・リセットなどの操作を複数クライアント間で即時共有するリアルタイム通信が必須。
- 立ち上げ当初は WebSocket を前提に検討していたが、Server-Sent Events (SSE) も候補として挙げられたため、選択理由を明確にする。
- 投票はクライアント発の操作が多く、Notion API 更新やリセットなど状態遷移イベントをサーバーとクライアント双方で扱う必要がある。

## 決定
WebSocket を採用し、SSE は採用しない。

主な理由:
1. **双方向通信が前提**: 投票送信、リセット、開示リクエストなどクライアント→サーバー方向のイベントが多く、SSE だと追加の HTTP POST を設ける必要があり複雑。
2. **即時性と整合性**: WebSocket は全二重通信で低レイテンシなイベント配信が可能。SSE はサーバー→クライアントの一方向通信であり、クライアント状態の整合性を取るために追加のメカニズムが必要。
3. **AWS 構成との親和性**: API Gateway WebSocket + Lambda + DynamoDB の案と組み合わせやすく、接続管理がマネージドで済む。SSE だと Lambda の長時間実行やステート管理が難しくなる。

## 比較

| 項目 | WebSocket | Server-Sent Events |
| --- | --- | --- |
| 通信方向 | 双方向 (クライアント → サーバー → クライアント) | 一方向 (サーバー → クライアント) |
| クライアントイベント送信 | 標準機能としてサポート | 別の HTTP 手段が必要 |
| 再接続 | API Gateway / AppSync などで自動サポート | ブラウザ実装で自動再接続。ただしサーバー側状態復元が必要 |
| AWS マネージドとの親和性 | API Gateway WebSocket, AppSync など多数 | ALB や Lambda では長時間接続に制約 |
| 実装複雑度 | イベントモデルを統一できる | サーバーとクライアントで別チャネルを管理する必要 |
| コスト/スケール | 接続数に応じた従量課金 | 長時間 HTTP 接続で Lambda を保持しにくい |

## 影響
- 全てのリアルタイムイベント (投票、開示、リセット、Notion 更新通知) を WebSocket メッセージとしてモデル化する。
- クライアント SDK は WebSocket ベース (AWS SDK / Ably SDK など) を利用。SSE 用の実装は不要。
- サーバー側はコネクション ID に紐付いてメッセージ送信できる必要があるため、API Gateway の WebSocket API を利用する構成を前提に詳細設計を進める。
- 将来 SSE を全く使えないわけではないが、補助用途 (通知ストリームのみ) に限定し、投票コアの機能からは切り離す。

## 残課題・フォローアップ
- API Gateway WebSocket のコストと接続上限を測定し、チームの予算・利用規模に合致するか確認。
- 切断 → 再接続時の state sync プロトコルを定義し、DynamoDB との整合性を担保。
- クライアント実装（Next.js）で WebSocket 再接続/バックオフ戦略を設計。
- 代替案が必要になった場合 (例: WebSocket ポートが閉じられたネットワーク環境) に備え、HTTP ポーリングなど最低限のフォールバック手段を検討する。
