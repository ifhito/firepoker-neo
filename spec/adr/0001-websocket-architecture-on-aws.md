# ADR 0001: AWS 上での WebSocket アーキテクチャ選定

- Status: Accepted
- Date: 2024-05-20
- Owner: Fire Pocker チーム

## 背景
- Fire Pocker のリアルタイム見積もり機能は、クライアント間で投票・開示・リセットなどのイベントを即時共有する必要がある。
- 既存コンセプトでは Vercel Realtime などのマネージド WebSocket を想定していたが、AWS 上で完結する構成案を選定したい。
- セッション状態の一貫性、Notion API 連携、運用負荷、コストをバランスさせる必要がある。

## 決定
Amazon ECS Fargate 上の単一タスク定義に、Next.js API/SSR コンテナ、WebSocket サーバーコンテナ、Redis サイドカーコンテナを同居させ、Application Load Balancer でルーティングする構成を採用する。  
ベンダーロックを最小化するため、以下のポリシーを設ける。
- WebSocket サーバーは標準的な Node.js/Express + ws または uWebSockets.js を採用し、クラウド固有機能に依存しない。
- セッション/投票データはタスク内にデプロイする Redis サイドカー (永続化なし) に保存し、データアクセス層はリポジトリによって抽象化する。必要があれば、自前で Redis ホスティングや他クラウドの同等サービスへ移行できる。
- IaC (Terraform) はネットワーク・ALB・ECS・サイドカー構成をモジュール化し、別クラウド (GCP Cloud Run + Redis コンテナ等) に移行する際も同様の構成を再現しやすくする。
- ビルド成果物はコンテナイメージとして ECR に保存するが、OCI 準拠イメージであるため他レジストリへの移行を容易にする。

今後の詳細設計フェーズで重大な制約が判明しない限り、この ECS ベースの構成をベースに実装を進める。

## 選定理由と比較

| 案 | 構成 | 長所 | 短所 | 総評 |
| --- | --- | --- | --- | --- |
| A | API Gateway WebSocket + Lambda + DynamoDB | フルマネージド、接続管理が容易、サーバーレスでスケーラブル | AWS 固有 API への依存が強い、DynamoDB 特有設計が必要 | ロックインを許容できるなら有力。 |
| B | AppSync Subscriptions + DynamoDB | GraphQL 型安全、認証統合が容易 | GraphQL 導入コスト、Resolver 設計が複雑 | GraphQL を前提にするプロジェクト向け。 |
| C | ECS Fargate 単一タスク (Next.js + WebSocket + Redis サイドカー) | コンテナ標準技術で構築できポータビリティが高い、タスク単位でコストを最小化 | 常駐運用・スケール調整が必要、Redis 揮発性に注意 | **ベンダーロックを抑えつつ最小構成で運用できるため採用。** |
| D | Amazon IVS Chat / Chime SDK | WebSocket 実装不要、マネージド | チャット前提 API をカスタマイズ、課金体系が特殊 | ユースケースがチャット寄りの場合にのみ検討。 |

評価観点:
- **状態管理**: セッション状態は Redis に保持し、タスク再起動時には Notion/再同期で復元する。案 C はデータ構造を任意のインメモリストアに載せ替えやすい。
- **Notion 連携**: Node.js ベースの処理で完結するため、どの案でも実装可能だが、コンテナであれば SDK バージョン管理が容易。
- **運用負荷**: サーバーレス (案 A/B) は運用負荷が低いがロックイン度が高い。案 C は運用コストが増える一方で可搬性が高い。
- **コストとスケール**: 従量課金の案 A/B は小規模で安価だが、接続上限やメッセージ課金に注意。案 C は常時稼働コストが発生するが、スケール戦略を自前で設計できる。
## 影響
- ECS クラスター、単一タスク定義 (Next.js / WebSocket / Redis)、ALB を Terraform で管理する。ネットワーク (VPC, サブネット, セキュリティグループ) とセキュリティポリシー設計が必要。
- コンテナイメージの CI/CD (GitHub Actions → ECR → ECS) を整備する。タスク全体をローリングで更新する仕組みが必須。
- WebSocket サーバーを自前で運用するため、スケールアウト/イン戦略やコネクション維持の監視 (ALB target group, CloudWatch) を整える。
- Redis が揮発性であることを前提に、タスク再起動時のセッション再同期手順と Notion に対するフェールセーフ更新フローを整備する。
- タスク数が少ない間はコスト効率が高い一方、スケールアウト時には役割分割を検討するロードマップを明示する。

## フォローアップ
- ECS サービスのスケーリングポリシーと ALB ルーティングルール (REST / WebSocket / 静的配信) を設計し、タスク分割を行う条件を定義する。
- Redis サイドカーのリソース設定 (メモリ上限、永続化オフ設定、起動順序) と監視項目を確定する。
- Notion への確定書き込みと Redis からの削除/同期を自動化するワークフローを実装する。
- 可観測性 (CloudWatch, OpenTelemetry) の実装計画とアラート閾値を設定する。
- 代替クラウドへの移行シナリオ (例: GCP Cloud Run + Redis コンテナ、Azure Container Apps + Azure Cache for Redis) をハイレベルで整理し、抽象化層が十分か検証する。
