name: Lead Time Metrics (Every 10 minutes)

on:
  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
  workflow_dispatch:
  # 10åˆ†ã”ã¨ã«å®Ÿè¡Œ (cronå½¢å¼: åˆ† æ™‚ æ—¥ æœˆ æ›œæ—¥)
  schedule:
    - cron: '*/10 * * * *'

permissions:
  contents: read

jobs:
  leadtime-metrics:
    name: Calculate Lead Time Metrics
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
    
    steps:
      - name: Get time range for last 10 minutes
        shell: bash
        run: |
          # ç¾åœ¨æ™‚åˆ»ã¨10åˆ†å‰ã®æ™‚åˆ»ã‚’å–å¾—
          end_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          start_time=$(date -u -d '10 minutes ago' +"%Y-%m-%dT%H:%M:%SZ")
          
          # GitHub Actionsç’°å¢ƒå¤‰æ•°ã«è¨­å®š
          echo "time_range=$start_time..$end_time"
          echo "time_range=$start_time..$end_time" >> "$GITHUB_ENV"
          echo "start_time=$start_time" >> "$GITHUB_ENV"
          echo "end_time=$end_time" >> "$GITHUB_ENV"

      - name: Run issue-metrics tool
        uses: github/issue-metrics@v3
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # FirePokerãƒªãƒã‚¸ãƒˆãƒªã®PRã®ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ã‚’è¨ˆæ¸¬ï¼ˆä½œæˆã‹ã‚‰ãƒãƒ¼ã‚¸ã¾ã§ï¼‰
          SEARCH_QUERY: 'repo:ifhito/firepoker-neo is:pr merged:${{ env.time_range }}'
          # è¡¨ç¤ºå†…å®¹ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
          HIDE_AUTHOR: false
          HIDE_TIME_TO_FIRST_RESPONSE: false
          HIDE_TIME_TO_CLOSE: false
          HIDE_TIME_TO_ANSWER: true
          HIDE_LABEL_METRICS: true
          REPORT_TITLE: 'FirePoker Lead Time Metrics - ${{ env.start_time }} to ${{ env.end_time }}'

      - name: Create issue with metrics
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: 'ğŸ“Š FirePoker Lead Time Report - ${{ env.start_time }}'
          token: ${{ secrets.GITHUB_TOKEN }}
          content-filepath: ./issue_metrics.md
          labels: |
            metrics
            leadtime
            automated
